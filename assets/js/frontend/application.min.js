(e=>{class t{constructor(e){this.$elm=e,this.isSaving=!1,this.isUpdating=!1,this.isCompany="business"===wc_sco_params.default_company_type,this.attachEvents()}attachEvents(){e(document).on("checkoutReady",(()=>{this.scoAPIEnabled=!0,this.observeSveaData()})),this.attachCheckoutEvents()}attachCheckoutEvents(){this.currentCountry=e(".wc-svea-checkout-page #billing_country").val(),e(document).on("change",".wc-svea-checkout-page #billing_country",(t=>{const s=e(".wc-svea-checkout-page #billing_country").val();this.currentCountry!=s&&(this.refreshData(),this.currentCountry=s)})),e(document).on("change",".wc-svea-checkout-page #shipping_method .shipping_method",this.refreshData.bind(this)),e(document).on("sco_refresh_data",this.refreshData.bind(this)),e(document).on("change",".wc-svea-checkout-page .wc-svea-checkout-form",this.saveOrderInformation.bind(this)),e(document).on("sco_save_order_information",this.saveOrderInformation.bind(this)),e("body").on("update_checkout",this.refreshData.bind(this)),e("body").on("click","#sco-change-payment",this.changePaymentMethod.bind(this))}observeSveaData(){"1"===wc_sco_params.sync_zip_code&&(window.scoApi.unobserveEvent("identity.postalCode",this.postalCodeChange.bind(this)),window.scoApi.observeEvent("identity.postalCode",this.postalCodeChange.bind(this))),window.scoApi.unobserveEvent("identity.isCompany",this.isCompanyChange.bind(this)),window.scoApi.observeEvent("identity.isCompany",this.isCompanyChange.bind(this)),document.removeEventListener("sveaCheckout:errorValidationCallback",this.validationError.bind(this)),document.addEventListener("sveaCheckout:errorValidationCallback",this.validationError.bind(this)),document.removeEventListener("sveaCheckout:shippingConfirmed",this.shippingConfirmed.bind(this)),document.addEventListener("sveaCheckout:shippingConfirmed",this.shippingConfirmed.bind(this))}isCompanyChange(e){void 0!==e.value&&e.value!==this.isCompany&&(this.isCompany=e.value,this.refreshData())}postalCodeChange(t){let s=e("#billing_postcode").val(),a=t.value||"";a&&s!==a&&(e("#billing_postcode").val(a),this.refreshData())}validationError(e){let t=e.detail.message||wc_sco_params.validation_failed;this.showErrors(t,!0)}shippingConfirmed(t){if(this.isUpdating)return;this.isUpdating=!0;const s={security:wc_sco_params.update_sco_order_nshift_information,price:t.detail.price,name:t.detail.name};this.setCheckoutUpdating(!0),e.ajax({type:"POST",url:wc_checkout_params.wc_ajax_url.toString().replace("%%endpoint%%","update_sco_order_nshift_information"),data:s,success:e=>{e&&e.fragments&&this.updateFragments(e.fragments),this.setCheckoutUpdating(!1)},complete:()=>{this.isUpdating=!1}})}saveOrderInformation(t){if(t.target.classList.contains("shipping_method")||t.target.classList.contains("country_select"))return;if(this.isSaving)return;if(this.isUpdating)return this.blockCheckout(!0),void e(document).one("updated_checkout",(()=>{this.saveOrderInformation(t)}));this.isSaving=!0;const s={security:wc_sco_params.update_sco_order_information,form_data:e(".wc-svea-checkout-form").serialize()};e.ajax({type:"POST",url:wc_checkout_params.wc_ajax_url.toString().replace("%%endpoint%%","update_sco_order_information"),data:s,success:t=>{t&&t.fragments&&this.updateFragments(t.fragments),this.isSaving=!1,e(document).trigger("sco_order_information_saved")}})}blockCheckout(t){t?e(".wc-svea-checkout-page").addClass("updating"):e(".wc-svea-checkout-page").removeClass("updating")}setCheckoutUpdating(e){this.blockCheckout(e),this.scoAPIEnabled&&window.scoApi.setCheckoutEnabled(!e)}changePaymentMethod(t){t.preventDefault(),e.ajax({url:wc_checkout_params.wc_ajax_url.toString().replace("%%endpoint%%","sco_change_payment_method"),method:"POST",data:{svea:!1,security:wc_checkout_params.change_payment_method},success:e=>{e.success&&window.location.reload()}})}getShipping(){const t=e(".wc-svea-checkout-form").serialize(),s=new URLSearchParams(t),a={};for(let[e,t]of s)a[e]=t;let i=null;return void 0!==a["shipping_method[0]"]&&(i=a["shipping_method[0]"]),i}refreshData(t,s=!1){if(this.isUpdating)return;if(this.isSaving)return this.blockCheckout(!0),void e(document).one("sco_order_information_saved",(()=>{this.refreshData(t,s)}));this.isUpdating=!0;let a={security:wc_sco_params.refresh_sco_snippet_nonce,post_data:e(".wc-svea-checkout-form").serialize(),force:s};const i=this.getShipping();this.setCheckoutUpdating(!0),e.ajax({type:"POST",url:wc_checkout_params.wc_ajax_url.toString().replace("%%endpoint%%","refresh_sco_snippet"),data:a,success:t=>{if(this.isUpdating=!1,!0!==t.reload&&"true"!==t.reload){if(e(".woocommerce-NoticeGroup-updateOrderReview").remove(),t&&t.fragments&&this.updateFragments(t.fragments),i!==this.getShipping())return this.refreshData(null,!0);"failure"===t.result&&(this.removeErrors(),t.messages?this.showErrors(t.messages):this.showErrors(t,!1)),e(document.body).trigger("updated_checkout",[t]),this.setCheckoutUpdating(!1)}else window.location.reload()},complete:()=>{this.isUpdating=!1}})}updateFragments(t){e.each(t,(function(t,s){e(t).replaceWith(s),e(t).unblock()}))}showErrors(t,s){this.removeErrors(),void 0===s&&(s=!0),s?this.$elm.prepend('<ul class="woocommerce-error"><li>'+t+"</li></ul>"):this.$elm.prepend(t),this.$elm.find(".input-text, select, input:checkbox").blur(),e("html, body").animate({scrollTop:this.$elm.offset().top-100},1e3)}removeErrors(){e(".woocommerce-error, .woocommerce-message").remove()}static instance(){e(this).length>0&&e(this).each(((s,a)=>{a.sveaCheckout=new t(e(a))}))}}function s(t){"svea_checkout"===t&&e.ajax({url:wc_checkout_params.wc_ajax_url.toString().replace("%%endpoint%%","sco_change_payment_method"),method:"POST",data:{svea:!0,security:wc_checkout_params.change_payment_method},success:e=>{e.success&&window.location.reload()}})}e.fn.sveaCheckout=t.instance,e(document).ready((t=>{e(".wc-svea-checkout-page").sveaCheckout()})),e(document.body).on("init_checkout",(t=>{e("body").on("change","input[name=payment_method]",(t=>{s(e(t.target).val())})),e(document.body).on("updated_checkout",(function(){s(e("input[name=payment_method]:checked").val())}))}))})(jQuery);